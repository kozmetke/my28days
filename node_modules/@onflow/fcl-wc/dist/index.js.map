{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/constants.ts","../src/session.ts","../src/service.ts","../src/fcl-wc.ts"],"sourcesContent":["import {log, LEVELS} from \"@onflow/util-logger\"\nimport {invariant} from \"@onflow/util-invariant\"\nimport * as fclCore from \"@onflow/fcl-core\"\n\nconst makeFlowServicesFromWallets = (wallets: any[]) => {\n  return Object.values(wallets)\n    .filter(w => w.app_type === \"wallet\")\n    .map(wallet => {\n      return {\n        f_type: \"Service\",\n        f_vsn: \"1.0.0\",\n        type: \"authn\",\n        method: \"WC/RPC\",\n        uid: wallet.mobile?.universal,\n        endpoint: \"flow_authn\",\n        optIn: true,\n        provider: {\n          address: null,\n          name: wallet.name,\n          icon: wallet.image_url?.sm,\n          description: wallet.description,\n          website: wallet.homepage,\n          color: wallet.metadata?.colors?.primary,\n          supportEmail: null,\n        },\n      }\n    })\n}\n\nexport const fetchFlowWallets = async (projectId: string) => {\n  try {\n    const network = await fclCore.getChainId()\n    const wcApiWallets = await fetch(\n      `https://explorer-api.walletconnect.com/v3/wallets?projectId=${projectId}&chains=flow:${network}&entries=5&page=1`\n    ).then(res => res.json())\n\n    if (wcApiWallets?.count > 0) {\n      return makeFlowServicesFromWallets(wcApiWallets.listings)\n    }\n\n    return []\n  } catch (error) {\n    if (error instanceof Error) {\n      log({\n        title: `${error.name} Error fetching wallets from WalletConnect API`,\n        message: error.message,\n        level: LEVELS.error,\n      })\n    }\n  }\n}\n\nexport function isAndroid() {\n  return (\n    typeof navigator !== \"undefined\" && /android/i.test(navigator.userAgent)\n  )\n}\n\nexport function isSmallIOS() {\n  return (\n    typeof navigator !== \"undefined\" && /iPhone|iPod/.test(navigator.userAgent)\n  )\n}\n\nexport function isLargeIOS() {\n  return typeof navigator !== \"undefined\" && /iPad/.test(navigator.userAgent)\n}\n\nexport function isIOS() {\n  return isSmallIOS() || isLargeIOS()\n}\n\nexport function isMobile() {\n  return isAndroid() || isIOS()\n}\n\nexport function openDeeplink(url: string) {\n  if (url.startsWith(\"http\")) {\n    // Workaround for https://github.com/rainbow-me/rainbowkit/issues/524.\n    // Using 'window.open' causes issues on iOS in non-Safari browsers and\n    // WebViews where a blank tab is left behind after connecting.\n    // This is especially bad in some WebView scenarios (e.g. following a\n    // link from Twitter) where the user doesn't have any mechanism for\n    // closing the blank tab.\n    // For whatever reason, links with a target of \"_blank\" don't suffer\n    // from this problem, and programmatically clicking a detached link\n    // element with the same attributes also avoids the issue.\n    const link = document.createElement(\"a\")\n    link.href = url\n    link.target = \"_blank\"\n    link.rel = \"noreferrer noopener\"\n    link.click()\n  } else {\n    window.open(url, \"_blank\")\n  }\n}\n","export enum FLOW_METHODS {\n  FLOW_AUTHN = \"flow_authn\",\n  FLOW_PRE_AUTHZ = \"flow_pre_authz\",\n  FLOW_AUTHZ = \"flow_authz\",\n  FLOW_USER_SIGN = \"flow_user_sign\",\n}\n\nexport enum REQUEST_TYPES {\n  SESSION_REQUEST = \"session_proposal\",\n  SIGNING_REQUEST = \"signing_request\",\n}\n","import * as fclCore from \"@onflow/fcl-core\"\nimport {FLOW_METHODS} from \"./constants\"\nimport {SignClient} from \"@walletconnect/sign-client/dist/types/client\"\nimport {PairingTypes, SessionTypes} from \"@walletconnect/types\"\n\n// Create a new session proposal with the WalletConnect client\nexport async function createSessionProposal({\n  client,\n  existingPairing,\n}: {\n  client: SignClient\n  existingPairing?: PairingTypes.Struct\n}) {\n  const network = await fclCore.getChainId()\n\n  const requiredNamespaces = {\n    flow: {\n      methods: [\n        FLOW_METHODS.FLOW_AUTHN,\n        FLOW_METHODS.FLOW_PRE_AUTHZ,\n        FLOW_METHODS.FLOW_AUTHZ,\n        FLOW_METHODS.FLOW_USER_SIGN,\n      ],\n      chains: [`flow:${network}`],\n      events: [\"chainChanged\", \"accountsChanged\"],\n    },\n  }\n\n  const {uri, approval} = await client.connect({\n    pairingTopic: existingPairing?.topic,\n    requiredNamespaces,\n  })\n\n  if (!uri) {\n    throw new Error(\n      \"FCL-WC: Error creating session proposal. Could not create a proposal URI.\"\n    )\n  }\n\n  return {uri, approval}\n}\n\nexport const request = async ({\n  method,\n  body,\n  session,\n  client,\n  abortSignal,\n}: {\n  method: any\n  body: any\n  session: SessionTypes.Struct\n  client: SignClient\n  abortSignal?: AbortSignal\n}) => {\n  const [chainId, addr, address] = makeSessionData(session)\n  const data = JSON.stringify({...body, addr, address})\n\n  const result: any = await Promise.race([\n    client.request({\n      topic: session.topic,\n      chainId,\n      request: {\n        method,\n        params: [data],\n      },\n    }),\n    new Promise((_, reject) => {\n      if (abortSignal?.aborted) {\n        reject(new Error(\"WalletConnect Request aborted\"))\n      }\n      abortSignal?.addEventListener(\"abort\", () => {\n        reject(new Error(\"WalletConnect Request aborted\"))\n      })\n    }),\n  ])\n\n  if (typeof result !== \"object\" || result == null) return\n\n  switch (result.status) {\n    case \"APPROVED\":\n      return result.data\n\n    case \"DECLINED\":\n      throw new Error(`Declined: ${result.reason || \"No reason supplied\"}`)\n\n    case \"REDIRECT\":\n      return result.data\n\n    default:\n      throw new Error(`Declined: No reason supplied`)\n  }\n}\n\nexport function makeSessionData(session: SessionTypes.Struct) {\n  const [namespace, reference, address] = Object.values<any>(session.namespaces)\n    .map(namespace => namespace.accounts)\n    .flat()\n    .filter(account => account.startsWith(\"flow:\"))[0]\n    .split(\":\")\n\n  const chainId = `${namespace}:${reference}`\n  const addr = address\n  return [chainId, addr, address]\n}\n","import {invariant} from \"@onflow/util-invariant\"\nimport {log, LEVELS} from \"@onflow/util-logger\"\nimport {isMobile, openDeeplink} from \"./utils\"\nimport {FLOW_METHODS, REQUEST_TYPES} from \"./constants\"\nimport {SignClient} from \"@walletconnect/sign-client/dist/types/client\"\nimport {createSessionProposal, makeSessionData, request} from \"./session\"\n\ntype WalletConnectModalType =\n  typeof import(\"@walletconnect/modal\").WalletConnectModal\n\nexport const SERVICE_PLUGIN_NAME = \"fcl-plugin-service-walletconnect\"\nexport const WC_SERVICE_METHOD = \"WC/RPC\"\n\nexport const makeServicePlugin = (\n  client: Promise<SignClient | null>,\n  opts: {\n    projectId: string\n    includeBaseWC: boolean\n    wallets: any[]\n    wcRequestHook: any\n    pairingModalOverride: any\n  } = {\n    projectId: \"\",\n    includeBaseWC: false,\n    wallets: [],\n    wcRequestHook: null,\n    pairingModalOverride: null,\n  }\n) => ({\n  name: SERVICE_PLUGIN_NAME,\n  f_type: \"ServicePlugin\",\n  type: \"discovery-service\",\n  serviceStrategy: {\n    method: WC_SERVICE_METHOD,\n    exec: makeExec(\n      client,\n      opts,\n      import(\"@walletconnect/modal\").then(m => m.WalletConnectModal)\n    ),\n  },\n  services: [],\n})\n\nconst makeExec = (\n  clientPromise: Promise<SignClient | null>,\n  {wcRequestHook, pairingModalOverride}: any,\n  WalletConnectModal: Promise<WalletConnectModalType>\n) => {\n  return async ({\n    service,\n    body,\n    opts,\n    abortSignal,\n  }: {\n    service: any\n    body: any\n    opts: any\n    abortSignal?: AbortSignal\n  }) => {\n    const client = await clientPromise\n    invariant(!!client, \"WalletConnect is not initialized\")\n\n    let session: any, pairing: any\n    const method = service.endpoint\n    const appLink = validateAppLink(service)\n    const pairings = client.pairing.getAll({active: true})\n\n    if (pairings.length > 0) {\n      pairing = pairings?.find(p => p.peerMetadata?.url === service.uid)\n    }\n\n    if (client.session.length > 0) {\n      const lastKeyIndex = client.session.keys.length - 1\n      session = client.session.get(client.session.keys.at(lastKeyIndex)!)\n    }\n\n    if (session == null) {\n      session = await new Promise((resolve, reject) => {\n        function onClose() {\n          reject(`Declined: Externally Halted`)\n        }\n\n        connectWc(WalletConnectModal)({\n          service,\n          onClose,\n          appLink,\n          client,\n          method,\n          pairing,\n          wcRequestHook,\n          pairingModalOverride,\n          abortSignal,\n        }).then(resolve, reject)\n      })\n    }\n\n    if (wcRequestHook && wcRequestHook instanceof Function) {\n      wcRequestHook({\n        type: REQUEST_TYPES.SIGNING_REQUEST,\n        method,\n        service,\n        session: session ?? null,\n        pairing: pairing ?? null,\n        uri: null,\n      })\n    }\n\n    if (\n      isMobile() &&\n      method !== FLOW_METHODS.FLOW_AUTHN &&\n      !(method === FLOW_METHODS.FLOW_AUTHZ && opts.initiatedByPreAuthz)\n    ) {\n      openDeeplink(appLink)\n    }\n\n    // Make request to the WalletConnect client and return the result\n    return await request({\n      method,\n      body,\n      session,\n      client,\n      abortSignal,\n    })\n\n    function validateAppLink({uid}: {uid: string}) {\n      if (!(uid && /^(ftp|http|https):\\/\\/[^ \"]+$/.test(uid))) {\n        log({\n          title: \"WalletConnect Service Warning\",\n          message: `service.uid should be a valid universal link url. Found: ${uid}`,\n          level: LEVELS.warn,\n        })\n      }\n      return uid\n    }\n  }\n}\n\n// Connect to WalletConnect directly from the browser via deep link or WalletConnectModal\nfunction connectWc(WalletConnectModal: Promise<WalletConnectModalType>) {\n  return async ({\n    service,\n    onClose,\n    appLink,\n    client,\n    method,\n    pairing,\n    wcRequestHook,\n    pairingModalOverride,\n    abortSignal,\n  }: {\n    service: any\n    onClose: any\n    appLink: string\n    client: SignClient\n    method: string\n    pairing: any\n    wcRequestHook: any\n    pairingModalOverride: any\n    abortSignal?: AbortSignal\n  }) => {\n    const projectId = client.opts?.projectId\n    invariant(\n      !!projectId,\n      \"Cannot establish connection, WalletConnect projectId is undefined\"\n    )\n\n    let _uri: string | null = null,\n      walletConnectModal: any\n\n    try {\n      const {uri, approval} = await createSessionProposal({\n        client,\n        existingPairing: pairing,\n      })\n      _uri = uri\n\n      if (wcRequestHook && wcRequestHook instanceof Function) {\n        wcRequestHook({\n          type: REQUEST_TYPES.SESSION_REQUEST,\n          method,\n          service,\n          session: null,\n          pairing: pairing ?? null,\n          uri: uri ?? null,\n        })\n      }\n\n      if (isMobile()) {\n        const queryString = new URLSearchParams({uri: uri}).toString()\n        let url = pairing == null ? appLink + \"?\" + queryString : appLink\n        openDeeplink(url)\n      } else if (!pairing) {\n        if (!pairingModalOverride) {\n          walletConnectModal = new (await WalletConnectModal)({\n            projectId,\n            walletConnectVersion: 2,\n          })\n          walletConnectModal.openModal({uri, onClose})\n        } else {\n          pairingModalOverride(uri, onClose)\n        }\n      }\n\n      const session = await Promise.race([\n        approval(),\n        new Promise((_, reject) => {\n          if (abortSignal?.aborted) {\n            reject(new Error(\"Session request aborted\"))\n          }\n          abortSignal?.addEventListener(\"abort\", () => {\n            reject(new Error(\"Session request aborted\"))\n          })\n        }),\n      ])\n      return session\n    } catch (error) {\n      if (error instanceof Error) {\n        log({\n          title: `${error.name} Error establishing WalletConnect session`,\n          message: `\n          ${error.message}\n          uri: ${_uri}\n        `,\n          level: LEVELS.error,\n        })\n      }\n      onClose()\n      throw error\n    } finally {\n      walletConnectModal?.closeModal()\n    }\n  }\n}\n","import * as fclCore from \"@onflow/fcl-core\"\nimport SignClient from \"@walletconnect/sign-client\"\nimport {invariant} from \"@onflow/util-invariant\"\nimport {LEVELS, log} from \"@onflow/util-logger\"\nexport {getSdkError} from \"@walletconnect/utils\"\nimport {SERVICE_PLUGIN_NAME, makeServicePlugin} from \"./service\"\nimport {CoreTypes} from \"@walletconnect/types\"\n\nexport interface FclWalletConnectConfig {\n  projectId: string\n  metadata?: CoreTypes.Metadata\n  includeBaseWC?: boolean\n  wcRequestHook?: any\n  pairingModalOverride?: any\n  wallets?: any[]\n}\n\nconst DEFAULT_RELAY_URL = \"wss://relay.walletconnect.com\"\nconst DEFAULT_LOGGER = \"debug\"\nlet clientPromise: Promise<SignClient | null> = Promise.resolve(null)\n\nconst initClient = async ({\n  projectId,\n  metadata,\n}: {\n  projectId: string\n  metadata?: CoreTypes.Metadata\n}) => {\n  invariant(\n    projectId != null,\n    \"FCL Wallet Connect Error: WalletConnect projectId is required\"\n  )\n  try {\n    return SignClient.init({\n      logger: DEFAULT_LOGGER,\n      relayUrl: DEFAULT_RELAY_URL,\n      projectId: projectId,\n      metadata: metadata,\n    })\n  } catch (error) {\n    if (error instanceof Error) {\n      log({\n        title: `${error.name} fcl-wc Init Client`,\n        message: error.message,\n        level: LEVELS.error,\n      })\n    }\n    throw error\n  }\n}\n\nexport const initLazy = (config: FclWalletConnectConfig) => {\n  const {FclWcServicePlugin, clientPromise} = initHelper(config)\n  fclCore.discovery.authn.update()\n\n  return {\n    FclWcServicePlugin,\n    clientPromise,\n  }\n}\n\nexport const init = async (config: FclWalletConnectConfig) => {\n  const {FclWcServicePlugin, clientPromise} = initLazy(config)\n  const client = await clientPromise\n  fclCore.discovery.authn.update()\n\n  return {\n    FclWcServicePlugin,\n    client,\n  }\n}\n\nconst initHelper = ({\n  projectId,\n  metadata,\n  includeBaseWC = false,\n  wcRequestHook = null,\n  pairingModalOverride = null,\n  wallets = [],\n}: FclWalletConnectConfig) => {\n  if (typeof window === \"undefined\") {\n    throw new Error(\n      \"FCL Wallet Connect Plugin can only be initialized in the browser\"\n    )\n  }\n\n  // Lazy load the SignClient\n  //  - Initialize the client if it doesn't exist\n  //  - If it does exist, return existing client\n  //  - If existing client fails to initialize, reinitialize\n  clientPromise = Promise.resolve(clientPromise)\n    .catch(() => null)\n    .then(_client => {\n      if (_client) {\n        return _client\n      } else {\n        return initClient({projectId, metadata})\n      }\n    })\n    .catch(e => {\n      log({\n        title: `WalletConnect Client Initialization Error`,\n        message: e.message ? e.message : e,\n        level: LEVELS.error,\n      })\n      throw e\n    })\n\n  const FclWcServicePlugin = makeServicePlugin(clientPromise, {\n    projectId,\n    includeBaseWC,\n    wcRequestHook,\n    pairingModalOverride,\n    wallets,\n  })\n\n  return {\n    FclWcServicePlugin,\n    clientPromise,\n  }\n}\n\n// Returns the SignClient instance used by this plugin if it has been initialized\nexport async function getSignClient() {\n  return clientPromise.then(client => {\n    if (!client) {\n      throw new Error(\"WalletConnect client not initialized\")\n    }\n\n    return client\n  })\n}\n\nexport {SERVICE_PLUGIN_NAME}\n"],"names":["isAndroid","navigator","test","userAgent","isSmallIOS","isLargeIOS","isIOS","isMobile","openDeeplink","url","startsWith","link","document","createElement","href","target","rel","click","window","open","FLOW_METHODS","REQUEST_TYPES","createSessionProposal","_ref","client","existingPairing","network","fclCore","getChainId","requiredNamespaces","flow","methods","FLOW_AUTHN","FLOW_PRE_AUTHZ","FLOW_AUTHZ","FLOW_USER_SIGN","chains","events","uri","approval","connect","pairingTopic","topic","Error","request","_ref2","method","body","session","abortSignal","chainId","addr","address","makeSessionData","data","JSON","stringify","result","Promise","race","params","_","reject","aborted","addEventListener","status","reason","namespace","reference","Object","values","namespaces","map","accounts","flat","filter","account","split","SERVICE_PLUGIN_NAME","WC_SERVICE_METHOD","makeServicePlugin","opts","arguments","length","undefined","projectId","includeBaseWC","wallets","wcRequestHook","pairingModalOverride","name","f_type","type","serviceStrategy","exec","makeExec","then","m","WalletConnectModal","services","clientPromise","service","invariant","pairing","endpoint","appLink","validateAppLink","pairings","getAll","active","find","p","peerMetadata","uid","lastKeyIndex","keys","get","at","resolve","onClose","connectWc","Function","SIGNING_REQUEST","initiatedByPreAuthz","_ref3","log","title","message","level","LEVELS","warn","_ref4","_uri","walletConnectModal","SESSION_REQUEST","queryString","URLSearchParams","toString","walletConnectVersion","openModal","error","closeModal","DEFAULT_RELAY_URL","DEFAULT_LOGGER","initClient","metadata","SignClient","init","logger","relayUrl","initLazy","config","FclWcServicePlugin","initHelper","discovery","authn","update","catch","_client","e","getSignClient"],"mappings":"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"}