{"version":3,"file":"index.umd.js","sources":["../src/rpc-error.ts","../src/rpc-client.ts"],"sourcesContent":["export enum RpcErrorCode {\n  INVALID_REQUEST = -32600,\n  METHOD_NOT_FOUND = -32601,\n  INVALID_PARAMS = -32602,\n  INTERNAL_ERROR = -32603,\n  PARSE_ERROR = -32700,\n}\n\nexport class RpcError extends Error {\n  constructor(\n    public code: RpcErrorCode,\n    public message: string,\n    public data?: any\n  ) {\n    super(message)\n  }\n}\n","import {RpcMessage, RpcNotificationMessage, RpcRequestMessage} from \"./messages\"\nimport {RpcError, RpcErrorCode} from \"./rpc-error\"\n\nexport type RpcRequest<P, R> = {\n  type: \"request\"\n  params: P\n  result: R\n}\n\nexport type RpcNotification<P> = {\n  type: \"notification\"\n  params: P\n}\n\nenum ReservedRpcMethods {\n  HELLO = \"rpc_hello\",\n}\n\ntype RequestHandler<T = any> = (params: T) => any\ntype NotificationHandler<T = any> = (params: T) => void\n\ntype PeerInfo = {\n  requests: string[]\n  notifications: string[]\n}\n\nexport class RpcClient<\n  PeerRequests extends Record<string, RpcRequest<any, any>>,\n  PeerNotifications extends Record<string, RpcNotification<any>>,\n> {\n  private id = 0\n\n  private setSend: (send: (msg: RpcMessage) => void) => void = () => {}\n  private _send: Promise<(msg: RpcMessage) => void> = new Promise(resolve => {\n    this.setSend = resolve\n  })\n\n  private resolvePeerInfo!: (info: PeerInfo) => void\n  private rejectPeerInfo!: (error: Error) => void\n  private peerInfo: Promise<PeerInfo> = new Promise((resolve, reject) => {\n    this.resolvePeerInfo = resolve\n    this.rejectPeerInfo = reject\n  })\n\n  private enabledNotifications: string[] = []\n  private requestHandlers: Record<string, RequestHandler> = {} as any\n  private subscriptions: Record<string, Set<NotificationHandler>> = {} as any\n  private messageListeners: ((msg: any) => void)[] = []\n\n  constructor({notifications}: {notifications?: string[]}) {\n    this.enabledNotifications = notifications || []\n    this.on(ReservedRpcMethods.HELLO, (info: PeerInfo) => {\n      this.resolvePeerInfo(info)\n      return this.ownInfo()\n    })\n  }\n\n  connect({send}: {send: (msg: RpcMessage) => void}) {\n    this.setSend(send)\n    this.requestWithoutConnection(ReservedRpcMethods.HELLO, this.ownInfo())\n      .then(info => {\n        this.resolvePeerInfo(info)\n      })\n      .catch(this.rejectPeerInfo)\n  }\n\n  private ownInfo(): PeerInfo {\n    return {\n      requests: Object.keys(this.requestHandlers),\n      notifications: this.enabledNotifications,\n    }\n  }\n\n  private async send(msg: RpcMessage) {\n    return (await this._send)(msg)\n  }\n\n  receive(msg: RpcMessage) {\n    if (msg?.jsonrpc !== \"2.0\") {\n      return\n    }\n\n    if (\"method\" in msg) {\n      if (\"id\" in msg) {\n        this.handleRequest(msg)\n      } else {\n        this.handleNotification(msg)\n      }\n    }\n\n    this.messageListeners.forEach(listener => listener(msg))\n  }\n\n  private async handleRequest(msg: RpcRequestMessage) {\n    const handler = this.requestHandlers[msg.method]\n    if (handler) {\n      try {\n        const result = await handler(msg.params)\n        this.send({\n          jsonrpc: \"2.0\",\n          id: msg.id,\n          result,\n        })\n      } catch (error: any) {\n        if (error instanceof RpcError) {\n          this.send({\n            jsonrpc: \"2.0\",\n            id: msg.id,\n            error: {\n              code: error.code,\n              message: error.message,\n              data: error.data,\n            },\n          })\n        } else {\n          this.send({\n            jsonrpc: \"2.0\",\n            id: msg.id,\n            error: {\n              code: RpcErrorCode.INTERNAL_ERROR,\n              message: error?.message,\n            },\n          })\n        }\n      }\n    } else {\n      this.send({\n        jsonrpc: \"2.0\",\n        id: msg.id,\n        error: {\n          code: RpcErrorCode.METHOD_NOT_FOUND,\n          message: `Method not found: ${msg.method}`,\n        },\n      })\n    }\n  }\n\n  private handleNotification(msg: RpcNotificationMessage) {\n    if (this.subscriptions[msg.method]) {\n      this.subscriptions[msg.method].forEach(handler => handler(msg.params))\n    }\n  }\n\n  private onMessage(listener: (msg: any) => void) {\n    this.messageListeners.push(listener)\n    return () => {\n      this.messageListeners = this.messageListeners.filter(l => l !== listener)\n    }\n  }\n\n  async notify<R extends keyof PeerNotifications & string>(\n    method: R,\n    params: PeerNotifications[R][\"params\"]\n  ) {\n    await this.onceConnected()\n\n    this.send({\n      jsonrpc: \"2.0\",\n      method,\n      params,\n    })\n  }\n\n  async request<R extends keyof PeerRequests & string>(\n    method: R,\n    params: PeerRequests[R][\"params\"]\n  ): Promise<PeerRequests[R][\"result\"]> {\n    await this.onceConnected()\n    return this.requestWithoutConnection(method, params)\n  }\n\n  private async requestWithoutConnection<R extends keyof PeerRequests & string>(\n    method: R,\n    params: PeerRequests[R][\"params\"]\n  ): Promise<PeerRequests[R][\"result\"]> {\n    const id = this.id++\n\n    let unsub = () => {}\n    const result = new Promise<PeerRequests[R][\"result\"]>((resolve, reject) => {\n      unsub = this.onMessage(msg => {\n        if (msg.id === id && (\"result\" in msg || \"error\" in msg)) {\n          if (msg.error) {\n            const rpcError = new RpcError(\n              msg.error.code,\n              msg.error.message,\n              msg.error.data\n            )\n            reject(rpcError)\n          }\n          resolve(msg.result)\n        }\n      })\n    }).finally(unsub)\n\n    this.send({\n      jsonrpc: \"2.0\",\n      method,\n      params,\n      id,\n    })\n\n    return result\n  }\n\n  on(method: string, handler: RequestHandler) {\n    this.requestHandlers[method] = handler\n  }\n\n  subscribe<R extends string>(method: R, handler: RequestHandler<any>) {\n    this.subscriptions[method] = this.subscriptions[method] || new Set()\n    this.subscriptions[method].add(handler)\n  }\n\n  unsubscribe<R extends string>(method: R, handler: RequestHandler<any>) {\n    this.subscriptions[method]?.delete(handler)\n  }\n\n  async onceConnected() {\n    return this.peerInfo.then(() => {})\n  }\n\n  async getAvailableRequests() {\n    return this.peerInfo.then(info => info.requests)\n  }\n\n  async getAvailableNotifications() {\n    return this.peerInfo.then(info => info.notifications)\n  }\n}\n"],"names":["RpcErrorCode","RpcError","Error","constructor","code","message","data","ReservedRpcMethods","RpcClient","_ref","notifications","_defineProperty","Promise","resolve","setSend","reject","resolvePeerInfo","rejectPeerInfo","enabledNotifications","on","HELLO","info","ownInfo","connect","_ref2","send","requestWithoutConnection","then","catch","requests","Object","keys","requestHandlers","msg","_send","receive","jsonrpc","handleRequest","handleNotification","messageListeners","forEach","listener","handler","method","result","params","id","error","INTERNAL_ERROR","METHOD_NOT_FOUND","subscriptions","onMessage","push","filter","l","notify","onceConnected","request","unsub","rpcError","finally","subscribe","Set","add","unsubscribe","delete","peerInfo","getAvailableRequests","getAvailableNotifications"],"mappings":";;;;;;;;;;AAAYA,MAAAA,YAAY,0BAAZA,YAAY,EAAA;EAAZA,EAAAA,YAAY,CAAZA,YAAY,CAAA,iBAAA,CAAA,GAAA,CAAA,KAAA,CAAA,GAAA,iBAAA,CAAA;EAAZA,EAAAA,YAAY,CAAZA,YAAY,CAAA,kBAAA,CAAA,GAAA,CAAA,KAAA,CAAA,GAAA,kBAAA,CAAA;EAAZA,EAAAA,YAAY,CAAZA,YAAY,CAAA,gBAAA,CAAA,GAAA,CAAA,KAAA,CAAA,GAAA,gBAAA,CAAA;EAAZA,EAAAA,YAAY,CAAZA,YAAY,CAAA,gBAAA,CAAA,GAAA,CAAA,KAAA,CAAA,GAAA,gBAAA,CAAA;EAAZA,EAAAA,YAAY,CAAZA,YAAY,CAAA,aAAA,CAAA,GAAA,CAAA,KAAA,CAAA,GAAA,aAAA,CAAA;EAAA,EAAA,OAAZA,YAAY,CAAA;EAAA,CAAA,CAAA,EAAA,EAAA;EAQjB,MAAMC,QAAQ,SAASC,KAAK,CAAC;EAClCC,EAAAA,WAAWA,CACFC,IAAkB,EAClBC,OAAe,EACfC,IAAU,EACjB;MACA,KAAK,CAACD,OAAO,CAAC,CAAA;MAAA,IAJPD,CAAAA,IAAkB,GAAlBA,IAAkB,CAAA;MAAA,IAClBC,CAAAA,OAAe,GAAfA,OAAe,CAAA;MAAA,IACfC,CAAAA,IAAU,GAAVA,IAAU,CAAA;EAGnB,GAAA;EACF;;ECfkD,IAa7CC,kBAAkB,0BAAlBA,kBAAkB,EAAA;IAAlBA,kBAAkB,CAAA,OAAA,CAAA,GAAA,WAAA,CAAA;EAAA,EAAA,OAAlBA,kBAAkB,CAAA;EAAA,CAAA,CAAlBA,kBAAkB,IAAA,EAAA,CAAA,CAAA;EAYhB,MAAMC,SAAS,CAGpB;IAoBAL,WAAWA,CAAAM,IAAA,EAA8C;MAAA,IAA7C;EAACC,MAAAA,aAAAA;EAAyC,KAAC,GAAAD,IAAA,CAAA;EAAAE,IAAAA,mCAAA,aAnB1C,CAAC,CAAA,CAAA;MAAAA,mCAAA,CAAA,IAAA,EAAA,SAAA,EAE+C,MAAM,EAAE,CAAA,CAAA;EAAAA,IAAAA,mCAAA,CACjB,IAAA,EAAA,OAAA,EAAA,IAAIC,OAAO,CAACC,OAAO,IAAI;QACzE,IAAI,CAACC,OAAO,GAAGD,OAAO,CAAA;EACxB,KAAC,CAAC,CAAA,CAAA;MAAAF,mCAAA,CAAA,IAAA,EAAA,UAAA,EAIoC,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEE,MAAM,KAAK;QACrE,IAAI,CAACC,eAAe,GAAGH,OAAO,CAAA;QAC9B,IAAI,CAACI,cAAc,GAAGF,MAAM,CAAA;EAC9B,KAAC,CAAC,CAAA,CAAA;EAAAJ,IAAAA,mCAAA,+BAEuC,EAAE,CAAA,CAAA;MAAAA,mCAAA,CAAA,IAAA,EAAA,iBAAA,EACe,EAAE,CAAA,CAAA;MAAAA,mCAAA,CAAA,IAAA,EAAA,eAAA,EACM,EAAE,CAAA,CAAA;EAAAA,IAAAA,mCAAA,2BACjB,EAAE,CAAA,CAAA;EAGnD,IAAA,IAAI,CAACO,oBAAoB,GAAGR,aAAa,IAAI,EAAE,CAAA;MAC/C,IAAI,CAACS,EAAE,CAACZ,kBAAkB,CAACa,KAAK,EAAGC,IAAc,IAAK;EACpD,MAAA,IAAI,CAACL,eAAe,CAACK,IAAI,CAAC,CAAA;EAC1B,MAAA,OAAO,IAAI,CAACC,OAAO,EAAE,CAAA;EACvB,KAAC,CAAC,CAAA;EACJ,GAAA;IAEAC,OAAOA,CAAAC,KAAA,EAA4C;MAAA,IAA3C;EAACC,MAAAA,IAAAA;EAAuC,KAAC,GAAAD,KAAA,CAAA;EAC/C,IAAA,IAAI,CAACV,OAAO,CAACW,IAAI,CAAC,CAAA;EAClB,IAAA,IAAI,CAACC,wBAAwB,CAACnB,kBAAkB,CAACa,KAAK,EAAE,IAAI,CAACE,OAAO,EAAE,CAAC,CACpEK,IAAI,CAACN,IAAI,IAAI;EACZ,MAAA,IAAI,CAACL,eAAe,CAACK,IAAI,CAAC,CAAA;EAC5B,KAAC,CAAC,CACDO,KAAK,CAAC,IAAI,CAACX,cAAc,CAAC,CAAA;EAC/B,GAAA;EAEQK,EAAAA,OAAOA,GAAa;MAC1B,OAAO;QACLO,QAAQ,EAAEC,MAAM,CAACC,IAAI,CAAC,IAAI,CAACC,eAAe,CAAC;QAC3CtB,aAAa,EAAE,IAAI,CAACQ,oBAAAA;OACrB,CAAA;EACH,GAAA;IAEA,MAAcO,IAAIA,CAACQ,GAAe,EAAE;EAClC,IAAA,OAAO,CAAC,MAAM,IAAI,CAACC,KAAK,EAAED,GAAG,CAAC,CAAA;EAChC,GAAA;IAEAE,OAAOA,CAACF,GAAe,EAAE;EACvB,IAAA,IAAIA,GAAG,EAAEG,OAAO,KAAK,KAAK,EAAE;EAC1B,MAAA,OAAA;EACF,KAAA;MAEA,IAAI,QAAQ,IAAIH,GAAG,EAAE;QACnB,IAAI,IAAI,IAAIA,GAAG,EAAE;EACf,QAAA,IAAI,CAACI,aAAa,CAACJ,GAAG,CAAC,CAAA;EACzB,OAAC,MAAM;EACL,QAAA,IAAI,CAACK,kBAAkB,CAACL,GAAG,CAAC,CAAA;EAC9B,OAAA;EACF,KAAA;MAEA,IAAI,CAACM,gBAAgB,CAACC,OAAO,CAACC,QAAQ,IAAIA,QAAQ,CAACR,GAAG,CAAC,CAAC,CAAA;EAC1D,GAAA;IAEA,MAAcI,aAAaA,CAACJ,GAAsB,EAAE;MAClD,MAAMS,OAAO,GAAG,IAAI,CAACV,eAAe,CAACC,GAAG,CAACU,MAAM,CAAC,CAAA;EAChD,IAAA,IAAID,OAAO,EAAE;QACX,IAAI;UACF,MAAME,MAAM,GAAG,MAAMF,OAAO,CAACT,GAAG,CAACY,MAAM,CAAC,CAAA;UACxC,IAAI,CAACpB,IAAI,CAAC;EACRW,UAAAA,OAAO,EAAE,KAAK;YACdU,EAAE,EAAEb,GAAG,CAACa,EAAE;EACVF,UAAAA,MAAAA;EACF,SAAC,CAAC,CAAA;SACH,CAAC,OAAOG,KAAU,EAAE;UACnB,IAAIA,KAAK,YAAY9C,QAAQ,EAAE;YAC7B,IAAI,CAACwB,IAAI,CAAC;EACRW,YAAAA,OAAO,EAAE,KAAK;cACdU,EAAE,EAAEb,GAAG,CAACa,EAAE;EACVC,YAAAA,KAAK,EAAE;gBACL3C,IAAI,EAAE2C,KAAK,CAAC3C,IAAI;gBAChBC,OAAO,EAAE0C,KAAK,CAAC1C,OAAO;gBACtBC,IAAI,EAAEyC,KAAK,CAACzC,IAAAA;EACd,aAAA;EACF,WAAC,CAAC,CAAA;EACJ,SAAC,MAAM;YACL,IAAI,CAACmB,IAAI,CAAC;EACRW,YAAAA,OAAO,EAAE,KAAK;cACdU,EAAE,EAAEb,GAAG,CAACa,EAAE;EACVC,YAAAA,KAAK,EAAE;gBACL3C,IAAI,EAAEJ,YAAY,CAACgD,cAAc;gBACjC3C,OAAO,EAAE0C,KAAK,EAAE1C,OAAAA;EAClB,aAAA;EACF,WAAC,CAAC,CAAA;EACJ,SAAA;EACF,OAAA;EACF,KAAC,MAAM;QACL,IAAI,CAACoB,IAAI,CAAC;EACRW,QAAAA,OAAO,EAAE,KAAK;UACdU,EAAE,EAAEb,GAAG,CAACa,EAAE;EACVC,QAAAA,KAAK,EAAE;YACL3C,IAAI,EAAEJ,YAAY,CAACiD,gBAAgB;EACnC5C,UAAAA,OAAO,EAAG,CAAA,kBAAA,EAAoB4B,GAAG,CAACU,MAAO,CAAA,CAAA;EAC3C,SAAA;EACF,OAAC,CAAC,CAAA;EACJ,KAAA;EACF,GAAA;IAEQL,kBAAkBA,CAACL,GAA2B,EAAE;MACtD,IAAI,IAAI,CAACiB,aAAa,CAACjB,GAAG,CAACU,MAAM,CAAC,EAAE;EAClC,MAAA,IAAI,CAACO,aAAa,CAACjB,GAAG,CAACU,MAAM,CAAC,CAACH,OAAO,CAACE,OAAO,IAAIA,OAAO,CAACT,GAAG,CAACY,MAAM,CAAC,CAAC,CAAA;EACxE,KAAA;EACF,GAAA;IAEQM,SAASA,CAACV,QAA4B,EAAE;EAC9C,IAAA,IAAI,CAACF,gBAAgB,CAACa,IAAI,CAACX,QAAQ,CAAC,CAAA;EACpC,IAAA,OAAO,MAAM;EACX,MAAA,IAAI,CAACF,gBAAgB,GAAG,IAAI,CAACA,gBAAgB,CAACc,MAAM,CAACC,CAAC,IAAIA,CAAC,KAAKb,QAAQ,CAAC,CAAA;OAC1E,CAAA;EACH,GAAA;EAEA,EAAA,MAAMc,MAAMA,CACVZ,MAAS,EACTE,MAAsC,EACtC;EACA,IAAA,MAAM,IAAI,CAACW,aAAa,EAAE,CAAA;MAE1B,IAAI,CAAC/B,IAAI,CAAC;EACRW,MAAAA,OAAO,EAAE,KAAK;QACdO,MAAM;EACNE,MAAAA,MAAAA;EACF,KAAC,CAAC,CAAA;EACJ,GAAA;EAEA,EAAA,MAAMY,OAAOA,CACXd,MAAS,EACTE,MAAiC,EACG;EACpC,IAAA,MAAM,IAAI,CAACW,aAAa,EAAE,CAAA;EAC1B,IAAA,OAAO,IAAI,CAAC9B,wBAAwB,CAACiB,MAAM,EAAEE,MAAM,CAAC,CAAA;EACtD,GAAA;EAEA,EAAA,MAAcnB,wBAAwBA,CACpCiB,MAAS,EACTE,MAAiC,EACG;EACpC,IAAA,MAAMC,EAAE,GAAG,IAAI,CAACA,EAAE,EAAE,CAAA;EAEpB,IAAA,IAAIY,KAAK,GAAGA,MAAM,EAAE,CAAA;MACpB,MAAMd,MAAM,GAAG,IAAIhC,OAAO,CAA4B,CAACC,OAAO,EAAEE,MAAM,KAAK;EACzE2C,MAAAA,KAAK,GAAG,IAAI,CAACP,SAAS,CAAClB,GAAG,IAAI;EAC5B,QAAA,IAAIA,GAAG,CAACa,EAAE,KAAKA,EAAE,KAAK,QAAQ,IAAIb,GAAG,IAAI,OAAO,IAAIA,GAAG,CAAC,EAAE;YACxD,IAAIA,GAAG,CAACc,KAAK,EAAE;cACb,MAAMY,QAAQ,GAAG,IAAI1D,QAAQ,CAC3BgC,GAAG,CAACc,KAAK,CAAC3C,IAAI,EACd6B,GAAG,CAACc,KAAK,CAAC1C,OAAO,EACjB4B,GAAG,CAACc,KAAK,CAACzC,IACZ,CAAC,CAAA;cACDS,MAAM,CAAC4C,QAAQ,CAAC,CAAA;EAClB,WAAA;EACA9C,UAAAA,OAAO,CAACoB,GAAG,CAACW,MAAM,CAAC,CAAA;EACrB,SAAA;EACF,OAAC,CAAC,CAAA;EACJ,KAAC,CAAC,CAACgB,OAAO,CAACF,KAAK,CAAC,CAAA;MAEjB,IAAI,CAACjC,IAAI,CAAC;EACRW,MAAAA,OAAO,EAAE,KAAK;QACdO,MAAM;QACNE,MAAM;EACNC,MAAAA,EAAAA;EACF,KAAC,CAAC,CAAA;EAEF,IAAA,OAAOF,MAAM,CAAA;EACf,GAAA;EAEAzB,EAAAA,EAAEA,CAACwB,MAAc,EAAED,OAAuB,EAAE;EAC1C,IAAA,IAAI,CAACV,eAAe,CAACW,MAAM,CAAC,GAAGD,OAAO,CAAA;EACxC,GAAA;EAEAmB,EAAAA,SAASA,CAAmBlB,MAAS,EAAED,OAA4B,EAAE;EACnE,IAAA,IAAI,CAACQ,aAAa,CAACP,MAAM,CAAC,GAAG,IAAI,CAACO,aAAa,CAACP,MAAM,CAAC,IAAI,IAAImB,GAAG,EAAE,CAAA;MACpE,IAAI,CAACZ,aAAa,CAACP,MAAM,CAAC,CAACoB,GAAG,CAACrB,OAAO,CAAC,CAAA;EACzC,GAAA;EAEAsB,EAAAA,WAAWA,CAAmBrB,MAAS,EAAED,OAA4B,EAAE;MACrE,IAAI,CAACQ,aAAa,CAACP,MAAM,CAAC,EAAEsB,MAAM,CAACvB,OAAO,CAAC,CAAA;EAC7C,GAAA;IAEA,MAAMc,aAAaA,GAAG;MACpB,OAAO,IAAI,CAACU,QAAQ,CAACvC,IAAI,CAAC,MAAM,EAAE,CAAC,CAAA;EACrC,GAAA;IAEA,MAAMwC,oBAAoBA,GAAG;MAC3B,OAAO,IAAI,CAACD,QAAQ,CAACvC,IAAI,CAACN,IAAI,IAAIA,IAAI,CAACQ,QAAQ,CAAC,CAAA;EAClD,GAAA;IAEA,MAAMuC,yBAAyBA,GAAG;MAChC,OAAO,IAAI,CAACF,QAAQ,CAACvC,IAAI,CAACN,IAAI,IAAIA,IAAI,CAACX,aAAa,CAAC,CAAA;EACvD,GAAA;EACF;;;;;;;;;;;;"}